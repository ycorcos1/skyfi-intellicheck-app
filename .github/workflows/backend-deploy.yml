name: Backend Deployment

on:
  push:
    branches:
      - main
      - production
    paths:
      - 'backend/**'
      - 'infra/**'
      - '.github/workflows/backend-deploy.yml'
      - 'scripts/health-check.sh'

env:
  AWS_REGION: us-east-1

permissions:
  contents: read

jobs:
  deploy-dev:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      ECR_REPOSITORY: skyfi-intellicheck-backend-dev
      ECS_CLUSTER: skyfi-intellicheck-cluster-dev
      ECS_SERVICE: skyfi-intellicheck-api-service-dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          docker build -t "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}" -t "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest" backend
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

      - name: Force new ECS deployment
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment \
            --region "${AWS_REGION}"

      - name: Wait for ECS service stability
        timeout-minutes: 15
        run: |
          set -euo pipefail
          echo "Waiting for ECS service to become stable..."
          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --region "${AWS_REGION}" \
            || {
              echo "⚠️  ECS service did not become stable within timeout"
              echo ""
              echo "=== Service Status ==="
              aws ecs describe-services \
                --cluster "${ECS_CLUSTER}" \
                --services "${ECS_SERVICE}" \
                --region "${AWS_REGION}" \
                --query 'services[0].{Status:status,Running:runningCount,Desired:desiredCount,Pending:pendingCount,Events:events[0:5]}' \
                --output json
              echo ""
              echo "=== Recent Task Status ==="
              TASK_ARNS=$(aws ecs list-tasks \
                --cluster "${ECS_CLUSTER}" \
                --service-name "${ECS_SERVICE}" \
                --region "${AWS_REGION}" \
                --query 'taskArns[0:3]' \
                --output text)
              if [ -n "$TASK_ARNS" ]; then
                for TASK_ARN in $TASK_ARNS; do
                  echo "Task: $TASK_ARN"
                  aws ecs describe-tasks \
                    --cluster "${ECS_CLUSTER}" \
                    --tasks "$TASK_ARN" \
                    --region "${AWS_REGION}" \
                    --query 'tasks[0].{LastStatus:lastStatus,HealthStatus:healthStatus,StoppedReason:stoppedReason,StoppedAt:stoppedAt,Containers:containers[0].{Name:name,LastStatus:lastStatus,Reason:reason,ExitCode:exitCode}}' \
                    --output json
                  echo ""
                done
              fi
              echo "=== Recent CloudWatch Logs ==="
              LOG_GROUP="/aws/ecs/skyfi-intellicheck-api-dev"
              aws logs tail "$LOG_GROUP" \
                --since 10m \
                --format short \
                --region "${AWS_REGION}" \
                --max-items 50 || echo "Could not fetch logs from $LOG_GROUP"
              exit 1
            }

      - name: Run API health checks
        env:
          API_URL: ${{ secrets.API_URL_DEV }}
        run: |
          set -euo pipefail
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh

      - name: Run API smoke tests
        env:
          API_URL: ${{ secrets.API_URL_DEV }}
        run: |
          set -euo pipefail
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh

  deploy-prod:
    if: github.ref == 'refs/heads/production'
    runs-on: ubuntu-latest
    environment:
      name: production
      # url: ${{ secrets.API_URL_PROD }}  # GitHub Actions doesn't support secrets in environment.url
    env:
      ECR_REPOSITORY: skyfi-intellicheck-backend-prod
      ECS_CLUSTER: skyfi-intellicheck-cluster-prod
      ECS_SERVICE: skyfi-intellicheck-api-service-prod
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          docker build -t "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}" -t "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest" backend
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

      - name: Force new ECS deployment
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment \
            --region "${AWS_REGION}"

      - name: Wait for ECS service stability
        timeout-minutes: 15
        run: |
          set -euo pipefail
          echo "Waiting for ECS service to become stable..."
          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --region "${AWS_REGION}" \
            || {
              echo "⚠️  ECS service did not become stable within timeout"
              echo "Checking service status..."
              aws ecs describe-services \
                --cluster "${ECS_CLUSTER}" \
                --services "${ECS_SERVICE}" \
                --region "${AWS_REGION}" \
                --query 'services[0].{Status:status,Running:runningCount,Desired:desiredCount,Events:events[0:3]}' \
                --output json
              echo "Checking task status..."
              aws ecs list-tasks \
                --cluster "${ECS_CLUSTER}" \
                --service-name "${ECS_SERVICE}" \
                --region "${AWS_REGION}" \
                --query 'taskArns[0:2]' \
                --output json | \
              xargs -I {} aws ecs describe-tasks \
                --cluster "${ECS_CLUSTER}" \
                --tasks {} \
                --region "${AWS_REGION}" \
                --query 'tasks[0].{LastStatus:lastStatus,HealthStatus:healthStatus,StoppedReason:stoppedReason}' \
                --output json || true
              exit 1
            }

      - name: Run API health checks
        env:
          API_URL: ${{ secrets.API_URL_PROD }}
        run: |
          set -euo pipefail
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh

      - name: Run API smoke tests
        env:
          API_URL: ${{ secrets.API_URL_PROD }}
        run: |
          set -euo pipefail
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh

